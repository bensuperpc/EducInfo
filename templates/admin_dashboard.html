{% extends 'base.html' %}
{% block content %}
<div class="min-h-full p-4">
    <!-- En-t√™te avec navigation par onglets -->
    <nav class="flex gap-2 mb-6" role="tablist">
        {% set tabs = [
            ('absences', 'Absences', 'üë•'),
            ('events', '√âv√©nements', 'üìÖ'),
            ('cantine', 'Menu Cantine', 'üçΩÔ∏è'),
            ('settings', 'Param√®tres', '‚öôÔ∏è')
        ] %}
        {% for id, label, icon in tabs %}
            <button class="tab-button px-6 py-3 rounded-lg font-medium transition-all" 
                    onclick="showTab('{{ id }}')"
                    role="tab"
                    aria-selected="false"
                    aria-controls="{{ id }}-panel">
                <span class="text-xl mr-2">{{ icon }}</span>
                {{ label }}
            </button>
        {% endfor %}
    </nav>

    <!-- Panneau des absences -->
    <div id="absences-panel" class="tab-panel bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <span class="text-3xl mr-3">üë•</span> Gestion des absences
        </h2>
        
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Formulaire d'ajout -->
            <div class="space-y-4">
                <form method="POST" class="space-y-4 bg-gray-50 p-4 rounded-lg">
                    {{ absence_form.hidden_tag() }}
                    <div class="flex gap-4">
                        {{ absence_form.professeur(class="flex-1 rounded border-gray-300", placeholder="Nom du professeur") }}
                        <button type="submit" name="submit_absence" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                            Ajouter
                        </button>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        {% for choice in absence_form.jours.choices %}
                        <label class="flex items-center space-x-2 bg-white p-2 rounded border hover:bg-gray-50">
                            <input type="checkbox" name="jours" value="{{ choice[0] }}" 
                                   class="text-indigo-600 rounded">
                            <span>{{ choice[1] }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </form>
            </div>

            <!-- Liste des absences -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Absences en cours</h3>
                {% if absences %}
                    <div class="space-y-2">
                        {% for absence in absences %}
                        <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                            <div>
                                <p class="font-medium">{{ absence.professeur }}</p>
                                <p class="text-sm text-gray-600">
                                    {% set jours = [] %}
                                    {%- if absence.lundi %}{% set _ = jours.append('Lun') %}{% endif -%}
                                    {%- if absence.mardi %}{% set _ = jours.append('Mar') %}{% endif -%}
                                    {%- if absence.mercredi %}{% set _ = jours.append('Mer') %}{% endif -%}
                                    {%- if absence.jeudi %}{% set _ = jours.append('Jeu') %}{% endif -%}
                                    {%- if absence.vendredi %}{% set _ = jours.append('Ven') %}{% endif -%}
                                    {{ jours|join(' - ') }}
                                </p>
                            </div>
                            <form method="POST" class="flex-none">
                                <input type="hidden" name="delete_absence" value="{{ absence.id }}">
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <span class="text-xl">üóëÔ∏è</span>
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-center">Aucune absence enregistr√©e</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Panneau des √©v√©nements -->
    <div id="events-panel" class="tab-panel bg-white rounded-xl shadow-lg p-6 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <span class="text-3xl mr-3">üìÖ</span> Gestion des √©v√©nements
        </h2>
        
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Formulaire d'ajout -->
            <form method="POST" class="space-y-4 bg-gray-50 p-4 rounded-lg">
                {{ event_form.hidden_tag() }}
                {{ event_form.title(class="w-full rounded border-gray-300", placeholder="Titre de l'√©v√©nement") }}
                {{ event_form.date(class="w-full rounded border-gray-300", type="date") }}
                {{ event_form.description(class="w-full rounded border-gray-300", rows="3", placeholder="Description (optionnel)") }}
                {{ event_form.submit_event(class="w-full px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
            </form>

            <!-- Liste des √©v√©nements -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">√âv√©nements √† venir</h3>
                {% if future_events %}
                    <div class="space-y-2">
                        {% for event in future_events %}
                        <div class="bg-white p-3 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">{{ event.title }}</p>
                                    <p class="text-sm text-indigo-600">{{ event.date.strftime('%d/%m/%Y') }}</p>
                                    {% if event.description %}
                                    <p class="text-sm text-gray-600 mt-1">{{ event.description }}</p>
                                    {% endif %}
                                </div>
                                <form method="POST" class="flex-none">
                                    <input type="hidden" name="delete_event" value="{{ event.id }}">
                                    <button type="submit" class="text-red-600 hover:text-red-800">
                                        <span class="text-xl">üóëÔ∏è</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-center">Aucun √©v√©nement pr√©vu</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Panneau de la cantine -->
    <div id="cantine-panel" class="tab-panel bg-white rounded-xl shadow-lg p-6 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <span class="text-3xl mr-3">üçΩÔ∏è</span> Gestion du Menu
        </h2>

        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Formulaire d'ajout -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Ajouter un plat</h3>
                <form method="POST" class="space-y-4">
                    {{ menu_form.hidden_tag() }}
                    <div class="grid gap-4">
                        {{ menu_form.category(class="w-full rounded border-gray-300") }}
                        {{ menu_form.name(class="w-full rounded border-gray-300", placeholder="Nom du plat") }}
                        {{ menu_form.description(class="w-full rounded border-gray-300", placeholder="Description (optionnel)") }}
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Caract√©ristiques</label>
                            <div class="flex flex-wrap gap-2">
                                {% for value, label in menu_form.icons.choices %}
                                <label class="inline-flex items-center bg-white px-3 py-1 rounded-full border hover:bg-gray-50">
                                    <input type="checkbox" name="icons" value="{{ value }}" class="mr-2">
                                    <span>{{ label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {{ menu_form.date(class="w-full rounded border-gray-300") }}
                        {{ menu_form.submit_menu_item(class="w-full px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
                    </div>
                </form>
            </div>

            <!-- Menu du jour -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Menu du jour</h3>
                    <form method="POST" class="flex items-center">
                        {{ widget_form.hidden_tag() }}
                        <div class="flex items-center space-x-2">
                            {{ widget_form.show_menu_cantine(class="w-5 h-5 text-indigo-600") }}
                            {{ widget_form.show_menu_cantine.label(class="text-sm text-gray-700") }}
                        </div>
                        {{ widget_form.submit_widget(class="ml-4 px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700") }}
                    </form>
                </div>

                {% if menu_items %}
                    <div class="space-y-4">
                        {% for cat_id, cat_name, cat_icon in MenuItem.get_menu_categories() %}
                            {% set category_items = [] %}
                            {% for item in menu_items %}
                                {% if item.category == cat_id %}
                                    {% set _ = category_items.append(item) %}
                                {% endif %}
                            {% endfor %}

                            {% if category_items %}
                                <div class="space-y-2">
                                    <h4 class="flex items-center font-medium text-gray-700">
                                        <span class="text-xl mr-2">{{ cat_icon }}</span>
                                        {{ cat_name }}
                                    </h4>
                                    {% for item in category_items %}
                                        <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                                            <div class="flex-1">
                                                <div class="font-medium">{{ item.name }}</div>
                                                {% if item.description %}
                                                    <div class="text-sm text-gray-600">{{ item.description }}</div>
                                                {% endif %}
                                                {% if item.icons %}
                                                    <div class="text-lg mt-1">{{ item.icons }}</div>
                                                {% endif %}
                                            </div>
                                            <form method="POST" class="ml-4">
                                                <input type="hidden" name="delete_menu_item" value="{{ item.id }}">
                                                <button type="submit" class="text-red-600 hover:text-red-800">
                                                    <span class="text-xl">üóëÔ∏è</span>
                                                </button>
                                            </form>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-gray-500 py-4">Aucun plat ajout√© pour aujourd'hui</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Panneau des param√®tres -->
    <div id="settings-panel" class="tab-panel bg-white rounded-xl shadow-lg p-6 hidden">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <span class="text-3xl mr-3">‚öôÔ∏è</span> Param√®tres
        </h2>
        
        <div class="grid gap-6">
            <!-- Configuration du site -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Configuration de l'√©tablissement</h3>
                <form method="POST" class="space-y-4">
                    {{ site_form.hidden_tag() }}
                    <div class="flex gap-4">
                        {{ site_form.site_name(class="flex-1 rounded border-gray-300", placeholder="Nom de l'√©tablissement") }}
                        {{ site_form.submit_site(class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
                    </div>
                </form>
            </div>

            <!-- Configuration de la m√©t√©o -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Configuration de la m√©t√©o</h3>
                <form method="POST" class="space-y-4">
                    {{ weather_form.hidden_tag() }}
                    <div class="flex items-center mb-4">
                        {{ weather_form.show_weather(class="mr-2") }}
                        {{ weather_form.show_weather.label(class="text-gray-700") }}
                    </div>
                    <div class="grid gap-4">
                        {{ weather_form.city(class="rounded border-gray-300", placeholder="Ville") }}
                        {{ weather_form.api_key(class="rounded border-gray-300", placeholder="Cl√© API OpenWeather") }}
                        {{ weather_form.submit_weather(class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
                    </div>
                </form>
            </div>

            <!-- Configuration des transports -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Configuration des Transports CTS</h3>
                <form method="POST" class="space-y-4">
                    {{ widget_form.hidden_tag() }}
                    <div class="flex items-center mb-4">
                        {{ widget_form.show_transports(class="mr-2") }}
                        {{ widget_form.show_transports.label(class="text-gray-700") }}
                    </div>
                    <div class="grid gap-4">
                        {{ widget_form.cts_stop_code(class="rounded border-gray-300", placeholder="Code d'arr√™t") }}
                        {{ widget_form.cts_vehicle_mode(class="rounded border-gray-300") }}
                        {{ widget_form.cts_api_token(class="rounded border-gray-300", placeholder="Cl√© API CTS") }}
                        {{ widget_form.submit_widget(class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
                    </div>
                </form>

                <!-- Pr√©visualisation CTS -->
                <div class="mt-6 border-t border-gray-200 pt-4">
                    <h4 class="font-medium text-gray-700 mb-4">Tester un arr√™t</h4>
                    <form method="POST" class="space-y-4">
                        {{ cts_form.hidden_tag() }}
                        <div class="grid gap-4">
                            {{ cts_form.stop_code(class="rounded border-gray-300", placeholder="Code d'arr√™t √† tester") }}
                            {{ cts_form.vehicle_mode(class="rounded border-gray-300") }}
                            <div class="flex gap-2">
                                {{ cts_form.submit_cts(class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700") }}
                                {{ cts_form.submit_cts_save(class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
                            </div>
                        </div>
                    </form>

                    {% if cts_results is defined and cts_results %}
                    <div class="mt-4 space-y-2">
                        <h5 class="font-medium text-gray-700">R√©sultats du test :</h5>
                        {% for visit in cts_results %}
                            {% set journey = visit.MonitoredVehicleJourney %}
                            <div class="bg-white p-3 rounded border">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">
                                        {% if journey.VehicleMode == 'bus' %}üöå{% else %}üöä{% endif %}
                                    </span>
                                    <span class="font-bold">{{ journey.PublishedLineName }}</span>
                                    <span class="text-gray-600">‚Üí {{ journey.DestinationName }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Modification du mot de passe -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Modification du mot de passe</h3>
                <form method="POST" class="space-y-4">
                    {{ password_form.hidden_tag() }}
                    {{ password_form.current_password(class="w-full rounded border-gray-300", placeholder="Mot de passe actuel") }}
                    {{ password_form.new_password(class="w-full rounded border-gray-300", placeholder="Nouveau mot de passe") }}
                    {{ password_form.confirm_password(class="w-full rounded border-gray-300", placeholder="Confirmer le mot de passe") }}
                    {{ password_form.submit_password(class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700") }}
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabId) {
        // Cache tous les panneaux
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.add('hidden');
        });
        
        // D√©s√©lectionne tous les onglets
        document.querySelectorAll('.tab-button').forEach(tab => {
            tab.classList.remove('bg-white', 'shadow-lg');
            tab.classList.add('bg-gray-100', 'hover:bg-white');
            tab.setAttribute('aria-selected', 'false');
        });
        
        // Affiche le panneau s√©lectionn√©
        const panel = document.getElementById(`${tabId}-panel`);
        panel.classList.remove('hidden');
        
        // Active l'onglet s√©lectionn√©
        const button = event.currentTarget;
        button.classList.remove('bg-gray-100', 'hover:bg-white');
        button.classList.add('bg-white', 'shadow-lg');
        button.setAttribute('aria-selected', 'true');
        
        // Sauvegarde l'onglet actif
        localStorage.setItem('activeTab', tabId);
    }

    // Restaure l'onglet actif au chargement
    document.addEventListener('DOMContentLoaded', () => {
        const activeTab = localStorage.getItem('activeTab') || 'absences';
        const tabButton = document.querySelector(`[aria-controls="${activeTab}-panel"]`);
        if (tabButton) tabButton.click();
    });
</script>
{% endblock %}
